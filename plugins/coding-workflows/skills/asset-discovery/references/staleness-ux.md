# Staleness UX for Pre-Generation Checks

Display templates and UX flows for pre-generation staleness checks in `generate-assets`. Two clearly separated sections: skills and agents.

---

## Skill Pre-Generation Checks

Before writing each skill file, apply the three-tier classification from the `coding-workflows:asset-discovery` skill:

1. **Self-match with provenance branching:** If the proposed output path matches an existing file:
   1. Read provenance fields (`generated_by`, `generated_at`) from existing file's frontmatter
   2. If generated: compare existing asset's `domains` array against current analysis domains for staleness (see `coding-workflows:asset-discovery` skill's Domain-Comparison Staleness Detection)
   3. Branch to appropriate UX:

   | # | State | UX |
   |---|-------|----|
   | 1 | Generated + stale | Show staleness summary (below). Suggest **Update** (default). Offer: Skip, Show full proposed content. |
   | 2 | Generated + current | "Asset is current (generated {date}). Skipping." |
   | 3 | Manually created | "Not generated by workflow commands. Skipping." (Informational: analysis notes if relevant, e.g., "analysis detected overlapping domains: X, Y") |

   **Error paths:**
   - Frontmatter unparseable: treat as manually created
   - `generated_by` present but `domains` array empty/missing: skip staleness detection, offer "Update or skip?"

   **Staleness summary format:**
   ```
   {filename} may need updating (generated {date}):

     New domains relevant to this asset:
     + {domain} (detected in {file_path}, {N} files)

     Domains no longer detected:
     - {domain} ({evidence})

     Framework changed:
     ~ {old} -> {new}

     [Update / Skip / Show full proposed content]
   ```

2. **BLOCK:** If exact name matches an installed plugin skill, refuse: "Skill `{name}` is already provided by the `{plugin}` plugin."
3. **WARN:** If similarity threshold exceeded (caught in Step 3 but re-checked here as safety net), confirm user's choice.
4. **Non-standard structure:** If `.claude/skills/` contains flat files (not in subdirectories), warn the user and suggest restructuring.

---

## Agent Pre-Generation Checks

Before writing each agent file, apply the three-tier classification from the `coding-workflows:asset-discovery` skill:

1. **Cross-name detection:** When generating `{domain}-{role}.md`, check if other agents exist at `.claude/agents/{domain}-*.md` with a different role suffix. If found, flag:
   "Existing agent `{domain}-{old_role}.md` found. The new agent will be generated as `{domain}-{role}.md`. Consider renaming or removing the old file to avoid confusion."
   This is informational only -- do not auto-delete.

2. **Self-match with provenance branching:** If `.claude/agents/{name}.md` already exists at the exact output path:
   1. Read provenance fields (`generated_by`, `generated_at`) from existing file's frontmatter
   2. If generated: compare existing asset's `domains` array against current analysis domains for staleness (see `coding-workflows:asset-discovery` skill's Domain-Comparison Staleness Detection). Also compare existing asset's `tools` field against the **role-specific** template tools (from `role-defaults.md` Role-Based Tool Sets table), using the agent's `role` field to select the correct template set. Also compare existing asset's `skills` array against the expected skills set (universal + domain-matched) for staleness (see `coding-workflows:asset-discovery` skill's Skills-Comparison Staleness Detection).
   3. Branch to appropriate UX:

   | # | State | UX |
   |---|-------|----|
   | 1 | Generated + stale | Show staleness summary (below). Suggest **Update** (default). Offer: Skip, Show full proposed content. |
   | 2 | Generated + current | "Asset is current (generated {date}). Skipping." |
   | 3 | Manually created | "Not generated by workflow commands. Skipping." (Informational: analysis notes if relevant, e.g., "analysis detected overlapping domains: X, Y") |

   **Error paths:**
   - Frontmatter unparseable: treat as manually created
   - `generated_by` present but `domains` array empty/missing: skip staleness detection, offer "Update or skip?"
   - `role` field absent: treat as `role: reviewer` (default) for comparison purposes
   - `tools` field absent: skip tools staleness (agent inherits all)
   - `tools` field empty string: treat as absent (skip tools staleness)
   - `tools` field is YAML list: normalize to set for comparison (same as comma-separated)
   - `skills` field absent: treat as stale (missing all expected skills)
   - `skills` field empty array: treat as stale (missing all expected skills)

   **Staleness summary format:**
   ```
   {filename} may need updating (generated {date}):

     New domains relevant to this asset:
     + {domain} (detected in {file_path}, {N} files)

     Domains no longer detected:
     - {domain} ({evidence})

     Framework changed:
     ~ {old} -> {new}

     Tools out of sync with current template:
     + {tool} (in template, missing from agent)
     - {tool} (in agent, not in current template)

     Skills drift:
       Missing universal skills:
       + {skill} (required by workflow -- agent predates upgrade)
       Missing domain skills:
       + {skill} (matches agent domains -- added since last generation)
       Dangling references:
       - {skill} (in agent, no longer resolves to any layer)
       User-added skills (informational):
       ~ {skill} (not in expected set -- preserved)

     [Update / Skip / Show full proposed content]
   ```

   **Tools staleness notes:**
   - The `+` lines are actioned during update (added via set-union). The `-` lines are informational only (user-added tools are preserved, template-removed tools are flagged for user awareness).
   - Users may edit `tools` freely. Template removals do NOT automatically propagate to existing agents. See `coding-workflows:agent-patterns` for `tools` field semantics and `coding-workflows:asset-discovery` for staleness signal definitions.

   **Skills staleness notes:**
   - Missing universal skills (`+` lines under "Missing universal skills") indicate the agent was generated before a workflow upgrade introduced the universal skill. These are always actioned during update.
   - Missing domain skills (`+` lines under "Missing domain skills") indicate the project's skill inventory has grown since the agent was generated. These are actioned during update.
   - Dangling references (`-` lines) indicate skills that were removed or renamed since generation. These are removed during update.
   - User-added skills (`~` lines) are informational only and preserved during update.

   **Update behavior for tools:** When the "Update" action is chosen for a stale agent, tools are merged via set-union: `updated_tools = existing_tools | template_tools`. This adds missing template tools while preserving user-added tools. When a role change is detected (existing `role` differs from proposed `role`), merge tools via set-union of the new role's default tools and any user-added tools from the existing agent. User-added tools are those present in the existing agent but NOT in the old role's default tool set.

   **Update behavior for skills:** When the "Update" action is chosen for a stale agent, skills are updated as: `updated_skills = (existing_skills - dangling_refs) | applicable_universal_skills | domain_matched_skills`. For execution-capable agents (those with `Write` or `Edit` tools), `applicable_universal_skills` includes all universal skills. For review-only agents (no `Write`/`Edit` tools), `applicable_universal_skills` is empty. This adds missing universal skills (execution-capable only) and domain skills, removes dangling references, and preserves user-added skills.

3. **BLOCK:** If exact name matches an existing agent in any layer, warn and offer rename.
4. **WARN:** If similarity threshold exceeded, confirm user's choice.
5. **Cross-type:** If keyword-bag overlap with an existing skill meets the threshold, note as informational (expected pattern for domain coverage).
